(()=>{"use strict";function e(e){var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return{overlayClick:(t=e,function(e){e.target===t.modalWindow&&n(t)}),keyEscDown:o(e),closeButtonClick:r(e),submit:i}}function t(e){var t=e.handlers,n=e.modalWindow,r=e.buttons;n.classList.add("popup_is-opened"),n.addEventListener("click",t.overlayClick),document.addEventListener("keydown",t.keyEscDown),r.close.addEventListener("click",t.closeButtonClick),t.submit&&e.form.addEventListener("submit",t.submit)}function n(e){var t=e.handlers,n=e.modalWindow,r=e.buttons;n.classList.remove("popup_is-opened"),n.removeEventListener("click",t.overlayClick),r.close.removeEventListener("click",t.closeButtonClick),document.removeEventListener("keydown",t.keyEscDown),t.submit&&e.form.removeEventListener("submit",t.submit)}function r(e){return function(){return n(e)}}function o(e){return function(t){"Escape"===t.code&&n(e)}}var i={baseUrl:"".concat("https://mesto.nomoreparties.co","/v1/").concat("wff-cohort-21"),headers:{authorization:"9c7c77e7-074c-48a7-957c-6b6c1ef95605","Content-Type":"application/json"}};function a(e,t,n){var r=[e],o={headers:i.headers,method:t};switch(t){case"GET":case"PUT":case"DELETE":r.push(n);break;case"POST":case"PATCH":o.body=JSON.stringify(n)}return new Promise((function(e,t){fetch(function(e){return"".concat(i.baseUrl,"/").concat(e.join("/"))}(r),o).then((function(n){n.ok?e(n.json()):t(n)})).catch((function(e){return t(e)}))}))}var u=function(e){return a("cards","DELETE",e)},c=function(e){return a("cards/likes","PUT",e)},l=function(e){return a("cards/likes","DELETE",e)};function s(e,t){console.error("[REQUEST ERROR]",e,t)}function d(e){e.preventDefault();var t=L[g.AVATAR];(function(e){return a("users/me/avatar","PATCH",e)})(t.fields.link.value).then((function(e){w.fields.avatar.setAttribute("src",e.avatar),n(t)})).catch((function(e){s("Avatar not saved.",e)}))}function p(e){var n=e.target,r=n.getAttribute("src"),o=n.getAttribute("alt"),i=L[g.IMAGE];i.items.image.setAttribute("src",r),i.items.image.setAttribute("alt",o),i.items.caption.textContent=o,t(i)}function f(e){var t,r,o,i;e.preventDefault(),t=L[g.NEW_CARD],i=function(e,t){return{name:e.fields.placeName.value,link:e.fields.link.value,likes:[],owner:t}}(t,r=S),(o=i,a("cards","POST",o)).then((function(e){var o=_(r,e,m,p,v);h.prepend(o.card),t.fields.placeName.value="",t.fields.link.value="",n(t)})).catch((function(e){s("Nev card not added.",e)}))}function _(e,t,n,r,o){var i=function(){var e=document.querySelector("#card-template").content.cloneNode(!0);return{card:e.querySelector(".card"),image:e.querySelector(".card__image"),title:e.querySelector(".card__title"),likeCount:e.querySelector(".card__like-count"),buttons:{delete:e.querySelector(".card__delete-button"),like:e.querySelector(".card__like-button")}}}(),a=i.image;return a.setAttribute("src",t.link),a.setAttribute("alt",t.name),a.addEventListener("click",r),i.title.textContent=t.name,e._id!==t.owner._id?i.buttons.delete.remove():i.buttons.delete.addEventListener("click",n),i.buttons.like.addEventListener("click",o),i.likeCount.textContent=t.likes.length,i.card.setAttribute("data-id",t._id),i}function m(e){var t=e.target.closest(".card"),n=t.getAttribute("data-id");u(n).then((function(){t.remove()})).catch((function(e){s("Card not deleted.",e)}))}function v(e){var t=e.target,n=e.target.closest(".card"),r=n.getAttribute("data-id"),o="card__like-button_is-active",i=n.querySelector(".card__like-count");(t.classList.contains(o)?l:c)(r).then((function(e){t.classList.toggle(o),i.textContent=e.likes.length})).catch((function(e){s(t.classList.contains(o)?"Like not deleted.":"Like not added.",e)}))}function y(e){return y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},y(e)}function b(e,t,n){return(t=function(e){var t=function(e){if("object"!=y(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=y(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==y(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var S,E,k,q,h=document.querySelector(".places__list"),A=document.querySelector(".profile__add-button"),C={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button-inactive",inputErrorClass:"popup__input-no-valid",errorClass:"validation_error_message"},g={EDIT:"edit",NEW_CARD:"new_card",IMAGE:"image",AVATAR:"avatar"},L=b(b(b(b({},g.EDIT,((k={modalWindow:E=document.querySelector(".popup_type_edit"),form:E.querySelector(".popup__form"),fields:{name:E.querySelector(".popup__input_type_name"),about:E.querySelector(".popup__input_type_description")},buttons:{close:E.querySelector(".popup__close"),submit:E.querySelector(".popup__button")}}).handlers=e(k,(function(e){e.preventDefault();var t,r=L[g.EDIT],o=r.fields.name.value,i=r.fields.about.value;r.buttons.submit.textContent="Сохранить...",(t={name:o,about:i},a("users/me","PATCH",t)).then((function(e){!function(e){var t=e.name,n=e.about;w.fields.name.textContent=t,w.fields.about.textContent=n}(e),n(r)})).catch((function(e){s("Profile not updated.",e)})).finally((function(){r.buttons.submit.textContent="Сохранить"}))})),k)),g.NEW_CARD,function(){var t=document.querySelector(".popup_type_new-card"),n={modalWindow:t,form:t.querySelector(".popup__form"),fields:{placeName:t.querySelector(".popup__input_type_card-name"),link:t.querySelector(".popup__input_type_url")},buttons:{close:t.querySelector(".popup__close")}};return n.handlers=e(n,f),n}()),g.IMAGE,function(){var t=document.querySelector(".popup_type_image"),n={modalWindow:t,items:{image:t.querySelector(".popup__image"),caption:t.querySelector(".popup__caption")},buttons:{close:t.querySelector(".popup__close")},handlers:e(t)};return n.handlers=e(n),n}()),g.AVATAR,function(){var t=document.querySelector(".popup_type_avatar"),n={modalWindow:t,form:t.querySelector(".popup__form"),fields:{link:t.querySelector(".popup__input_type_url")},buttons:{close:t.querySelector(".popup__close")}};return n.handlers=e(n,d),n}()),w={fields:{avatar:(q=document.querySelector(".profile")).querySelector(".profile__avatar"),avatarEdit:q.querySelector(".profile__avatar_icon_edit"),name:q.querySelector(".profile__title"),about:q.querySelector(".profile__description")}},T=["patternMismatch"];function D(e){e.innerHTML=""}function W(e){var t=L[e].modalWindow,n=C.formSelector,r=C.inputSelector,o=C.submitButtonSelector,i=C.inactiveButtonClass,a=C.inputErrorClass,u=C.errorClass,c=t.querySelector(n),l=c.querySelectorAll(r),s=c.querySelector(o);l.forEach((function(e){e.addEventListener("input",(function(){var t=c.querySelector(".popup__input_error_message__"+e.name);if(t.classList.add(u),e.validity.valid)return e.classList.remove(a),D(t),s.classList.remove(i),void s.removeAttribute("disabled");e.classList.add(a),s.classList.add(i),s.setAttribute("disabled","");var n=function(e){return T.map((function(t){var n="data-"+t;if(e.hasAttribute(n))return{status:t,message:e.getAttribute(n)}})).filter(Boolean)}(e);n.forEach((function(n){var r=n.status,o=n.message;e.validity[r]?function(e,t,n){(function(e,t){return!!e.querySelector(".validation_error_message_type_"+t)})(e,t)||e.appendChild(function(e,t){var n=document.createElement("div");return n.classList.add("validation_error_message_item","validation_error_message_type_"+e),n.textContent=t,n}(t,n))}(t,r,o):function(e,t){var n=e.querySelector(".validation_error_message_type_"+t);n&&n.remove()}(t,r)}))}))}))}function x(e){var t=C.formSelector,n=C.inputSelector,r=C.submitButtonSelector,o=C.inactiveButtonClass,i=C.inputErrorClass,a=e.querySelector(t),u=a.querySelectorAll(n);a.querySelector(r).classList.add(o),u.forEach((function(e){D(a.querySelector(".popup__input_error_message__"+e.name)),e.classList.remove(i)}))}A.addEventListener("click",(function(e){var n;x((n=L[g.NEW_CARD]).modalWindow),t(n)})),document.querySelector(".profile__edit-button").addEventListener("click",(function(e){var n,r,o;n=w.fields.name.textContent,r=w.fields.about.textContent,x((o=L[g.EDIT]).modalWindow),o.fields.name.value=n,o.fields.about.value=r,t(o)})),w.fields.avatarEdit.addEventListener("click",(function(e){var n=L[g.AVATAR];n.fields.link.vablue=w.fields.avatar.getAttribute("src"),t(n)})),W(g.EDIT),W(g.NEW_CARD),a("users/me","GET").then((function(e){!function(e){S=e}(e),function(e){w.fields.avatar.setAttribute("src",e.avatar),w.fields.name.textContent=e.name,w.fields.about.textContent=e.about}(e),a("cards").then((function(e){return function(e,t){e.forEach((function(e){var n=_(t,e,m,p,v);h.append(n.card)}))}(e,S)})).catch((function(e){s("Cards not loaded.",e)}))})).catch((function(e){s("Profile not loaded.",e)}))})();